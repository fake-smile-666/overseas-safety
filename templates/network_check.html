{% extends 'base.html' %}

{% block title %}网络连接指南 - 海外安全助手{% endblock %}

{% block content %}
<div class="card shadow">
    <div class="card-header bg-primary text-white">
        <h2 class="mb-0"><i class="bi bi-wifi me-2"></i>网络连接指南</h2>
    </div>
    <div class="card-body">
        <div class="alert alert-info">
            <p class="mb-0"><i class="bi bi-info-circle me-2"></i>本页面可帮助您解决移动设备连接问题。</p>
        </div>
        
        <h4 class="mt-4 mb-3"><i class="bi bi-hdd-network me-2"></i>服务器信息</h4>
        <div class="card mb-4">
            <div class="card-body bg-light">
                <div class="row">
                    <div class="col-5 col-md-3 fw-bold">服务器地址:</div>
                    <div class="col-7 col-md-9">{{ local_ip }}</div>
                </div>
                <div class="row mt-2">
                    <div class="col-5 col-md-3 fw-bold">端口:</div>
                    <div class="col-7 col-md-9">{{ port }}</div>
                </div>
                <div class="row mt-2">
                    <div class="col-5 col-md-3 fw-bold">访问地址:</div>
                    <div class="col-7 col-md-9">
                        <span class="badge bg-info">http://{{ local_ip }}:{{ port }}</span>
                    </div>
                </div>
            </div>
        </div>
        
        <h4 class="mb-3"><i class="bi bi-card-checklist me-2"></i>连接步骤</h4>
        <div class="card mb-4">
            <div class="card-body">
                <ol class="mb-0">
                    <li class="mb-2">确保您的手机已连接到与电脑<strong>相同的WiFi网络</strong></li>
                    <li class="mb-2">打开手机浏览器，输入以下地址:
                        <div class="alert alert-secondary mt-1">
                            <span class="font-monospace">http://{{ local_ip }}:{{ port }}</span>
                        </div>
                    </li>
                    <li class="mb-2">如果无法连接，请尝试下方的<a href="#troubleshoot">故障排除</a>部分</li>
                    <li>连接成功后，可以<a href="#bookmark">添加到主屏幕</a>以便下次访问</li>
                </ol>
            </div>
        </div>
        
        <h4 id="troubleshoot" class="mb-3"><i class="bi bi-tools me-2"></i>故障排除</h4>
        <div class="accordion mb-4" id="troubleshootAccordion">
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingOne">
                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne">
                        <i class="bi bi-wifi me-2"></i>检查网络连接
                    </button>
                </h2>
                <div id="collapseOne" class="accordion-collapse collapse show" data-bs-parent="#troubleshootAccordion">
                    <div class="accordion-body">
                        <p>您的手机和电脑必须连接到同一个WiFi网络：</p>
                        <ul>
                            <li>确认手机已连接WiFi（而非移动数据）</li>
                            <li>确认手机和电脑连接的是同一个WiFi网络名称</li>
                            <li>尝试使用其他应用（如微信文件传输）测试两个设备是否可以相互连接</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingTwo">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo">
                        <i class="bi bi-shield-check me-2"></i>防火墙设置
                    </button>
                </h2>
                <div id="collapseTwo" class="accordion-collapse collapse" data-bs-parent="#troubleshootAccordion">
                    <div class="accordion-body">
                        <p>Windows防火墙可能阻止了连接。请尝试：</p>
                        <ol>
                            <li>临时关闭防火墙：
                                <ul>
                                    <li>控制面板 → Windows Defender防火墙 → 启用或关闭Windows Defender防火墙</li>
                                    <li>选择"关闭Windows Defender防火墙"（测试完成后请记得重新开启）</li>
                                </ul>
                            </li>
                            <li>或添加例外规则：
                                <ul>
                                    <li>控制面板 → Windows Defender防火墙 → 高级设置</li>
                                    <li>入站规则 → 新建规则 → 端口</li>
                                    <li>选择TCP，然后输入特定本地端口：{{ port }}</li>
                                    <li>选择"允许连接"，完成规则创建</li>
                                </ul>
                            </li>
                        </ol>
                    </div>
                </div>
            </div>
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingThree">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree">
                        <i class="bi bi-globe me-2"></i>尝试其他IP地址
                    </button>
                </h2>
                <div id="collapseThree" class="accordion-collapse collapse" data-bs-parent="#troubleshootAccordion">
                    <div class="accordion-body">
                        <p>如果上面显示的IP地址不正确，您可以尝试使用电脑的其他IP地址：</p>
                        <ol>
                            <li>在电脑上打开命令提示符：按Win+R，输入cmd并回车</li>
                            <li>在命令提示符中输入<code>ipconfig</code>并回车</li>
                            <li>查找"IPv4 地址"，可能会有多个，分别尝试：
                                <ul>
                                    <li>无线网卡地址（通常以192.168开头）</li>
                                    <li>有线网卡地址（可能以192.168或10开头）</li>
                                </ul>
                            </li>
                            <li>在手机浏览器中尝试访问：<code>http://[找到的IP]:{{ port }}</code></li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
        
        <h4 id="bookmark" class="mb-3"><i class="bi bi-bookmark-plus me-2"></i>添加到主屏幕</h4>
        <div class="card mb-4">
            <div class="card-body">
                <p>将应用添加到手机主屏幕，方便下次直接访问：</p>
                
                <div class="accordion" id="bookmarkAccordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseIOS">
                                <i class="bi bi-apple me-2"></i>iPhone/iOS设备
                            </button>
                        </h2>
                        <div id="collapseIOS" class="accordion-collapse collapse" data-bs-parent="#bookmarkAccordion">
                            <div class="accordion-body">
                                <ol>
                                    <li>在Safari浏览器中打开应用</li>
                                    <li>点击底部中间的"分享"按钮 <i class="bi bi-box-arrow-up"></i></li>
                                    <li>滚动并选择"添加到主屏幕"</li>
                                    <li>输入应用名称（如"海外安全助手"）</li>
                                    <li>点击"添加"完成</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                    
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAndroid">
                                <i class="bi bi-android2 me-2"></i>Android设备
                            </button>
                        </h2>
                        <div id="collapseAndroid" class="accordion-collapse collapse" data-bs-parent="#bookmarkAccordion">
                            <div class="accordion-body">
                                <ol>
                                    <li>在Chrome浏览器中打开应用</li>
                                    <li>点击右上角的菜单按钮（三个点）</li>
                                    <li>选择"添加到主屏幕"或"安装应用"</li>
                                    <li>确认应用名称</li>
                                    <li>点击"添加"完成</li>
                                </ol>
                                <p class="small text-muted">注意：不同品牌的Android手机可能操作略有不同</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <h4 class="mb-3"><i class="bi bi-speedometer2 me-2"></i>连接测试</h4>
        <div class="d-grid gap-2">
            <button class="btn btn-primary" type="button" onclick="testConnection()">
                <i class="bi bi-speedometer2 me-2"></i>测试连接
            </button>
            <div id="connectionResult" class="mt-3"></div>
        </div>
        
        <div class="mt-4 text-center">
            <a href="{{ url_for('index') }}" class="btn btn-secondary">
                <i class="bi bi-arrow-left me-2"></i>返回首页
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function testConnection() {
    const startTime = new Date().getTime();
    const resultDiv = document.getElementById('connectionResult');
    
    resultDiv.innerHTML = '<div class="alert alert-info">正在测试连接...</div>';
    
    fetch('/network-check')
        .then(response => {
            const endTime = new Date().getTime();
            const timeTaken = endTime - startTime;
            
            if (response.ok) {
                resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        <h5><i class="bi bi-check-circle me-2"></i>连接成功！</h5>
                        <p>服务器响应时间: ${timeTaken}ms</p>
                        <p>如果您在手机上看到这个测试结果，说明您的手机已经可以正常访问应用。</p>
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <h5><i class="bi bi-exclamation-triangle me-2"></i>连接异常</h5>
                        <p>服务器返回状态码: ${response.status}</p>
                        <p>请检查网络设置或联系管理员。</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            resultDiv.innerHTML = `
                <div class="alert alert-danger">
                    <h5><i class="bi bi-exclamation-triangle me-2"></i>连接失败</h5>
                    <p>错误信息: ${error.message}</p>
                    <p>请检查网络设置或联系管理员。</p>
                </div>
            `;
        });
}
</script>
{% endblock %} 